<?php
    $this->layout()->breadcrumbs = false;
?>
<div vocab="http://schema.org/">
  <h1><?=$this->authority()->getName($this->driver)?></h1>
  <div class="row">
    <div class="col-sm-8">
      <p>
        <?php $professions = $this->authority()->getProfessions($this->driver);?>
        <?php if ($professions != ''): ?>
          <?=$professions?>
        <?php endif; ?>

        <?php $birth = $this->authority()->getBirth($this->driver); ?>
        <?php if ($birth != ''): ?>
          <br/><?=$birth?>
        <?php endif; ?>

        <?php $death = $this->authority()->getDeath($this->driver); ?>
        <?php if ($death != ''): ?>
          <br/><?=$death?>
        <?php endif; ?>
      </p>
      <?=$this->context($this)->renderInContext('related/AuthorityTitles', ['driver' => $this->driver])?>
    </div>
    <div class="col-sm-4">
      <?php
        // Image (partially rendered by JS)
        $imgUrl = '/wikidataproxy/load';
        $wikidataId = $this->driver->getWikidataId();
        if ($wikidataId != null) {
          $imgUrl .= '?id=' . $wikidataId;
        } else {
          $imgUrl .= '?search[]=';
          $names = $this->driver->getNameAliases();
          $encodedNames = [];
          foreach ($names as $name) {
            $encodedNames[] = urlencode($name);
          }
          $imgUrl .= implode('&search[]=', $encodedNames);
          $params = ['birthYear' => $this->driver->getBirthYear(),
                     'deathYear' => $this->driver->getDeathYear()];
          foreach ($params as $key => $value) {
            if ($value)
              $imgUrl .= '&' . urlencode($key) . '=' . urlencode($value);
          }
        }
      ?>
      <!-- onload didn't work, so we use a separate script snippet -->
      <div class="tf-wikidata-image" data-url="<?=htmlspecialchars($imgUrl)?>"></div>
      <script>TueFind.GetImagesFromWikidata();</script>
    </div>
  </div>
  <br>
  <?php
    // the tab logic is taken from non-authority core record driver
    // (authority records normally don't have tabs)
    if (!isset($this->activeTab))
      $this->activeTab = 'Details';
  ?>
  <?php if (count($this->tabs) > 0): ?>
    <div class="record-tabs">
      <ul class="nav nav-tabs">
        <?php foreach ($this->tabs as $tab => $obj): ?>
          <?php // add current tab to breadcrumbs if applicable:
            $desc = $obj->getDescription();
            $tabName = preg_replace("/\W/", "-", strtolower($tab));
            $tabClasses = [ 'record-tab', $tabName ];
            if (0 === strcasecmp($this->activeTab, $tab)) {
              if (!$this->loadInitialTabWithAjax || !$obj->supportsAjax()) {
                $tabClasses[] = 'active';
              }
              $tabClasses[] = 'initiallyActive';
              $this->layout()->breadcrumbs .= '<li class="active">' . $this->transEsc($desc) . '</li>';
              $activeTabObj = $obj;
            }
            if (!$obj->isVisible()) { $tabClasses[] = 'hidden'; }
            if (!$obj->supportsAjax()) { $tabClasses[] = 'noajax'; }
          ?>
          <li class="<?=implode(' ', $tabClasses)?>" data-tab="<?=$tabName?>">
            <a href="<?=$this->recordLink()->getTabUrl($this->driver, $tab)?>#tabnav"><?=$this->transEsc($desc)?></a>
          </li>
        <?php endforeach; ?>
      </ul>

      <div class="tab-content">
        <?php if (!$this->loadInitialTabWithAjax || !isset($activeTabObj) || !$activeTabObj->supportsAjax()): ?>
          <div class="tab-pane active <?=$this->escapeHtmlAttr($this->activeTab) ?>-tab">
            <?=isset($activeTabObj) ? $this->record($this->driver)->getTab($activeTabObj) : '' ?>
          </div>
        <?php endif; ?>
      </div>
    </div>
  <?php endif; ?>
</div>